<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKAN Sync Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .demo-badge {
            background: #fbbf24;
            color: #92400e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 400px;
            position: relative;
        }

        .failures-panel, .dataset-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .dataset-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .dataset-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.3s;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .dataset-item:hover {
            background: #f9fafb;
        }

        .dataset-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .dataset-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dataset-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .dataset-status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .dataset-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .dataset-status.running {
            background: #dbeafe;
            color: #1e40af;
        }

        .dataset-frequency {
            color: #6b7280;
            font-size: 12px;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .failure-item {
            padding: 15px;
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .failure-name {
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 8px;
        }

        .failure-message {
            font-size: 14px;
            color: #7f1d1d;
            line-height: 1.4;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .empty-state {
            text-align: center;
            color: #6b7280;
            padding: 40px;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            color: #1e40af;
        }

        .success-rate {
            font-size: 18px;
            font-weight: 600;
        }

        .success-rate.good { color: #059669; }
        .success-rate.warning { color: #d97706; }
        .success-rate.poor { color: #dc2626; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä CKAN Sync Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <a href="/calendar" class="btn" style="text-decoration: none;">üìÖ Calendar View</a>
                <div class="demo-badge">DEMO VERSION</div>
            </div>
        </div>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Demo Dashboard:</strong> This is a simplified version using SQLite with sample data.
            Perfect for testing the interface and understanding the system capabilities.
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Datasets</div>
                <div class="stat-value" id="totalDatasets">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value success-rate" id="successRate">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Records Synced</div>
                <div class="stat-value" id="recordsSynced">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Failed Syncs</div>
                <div class="stat-value" id="failedSyncs">-</div>
            </div>
        </div>

        <div class="main-content">
            <div class="dataset-list">
                <h2 class="chart-title">Dataset Status</h2>
                <div id="datasetsList">
                    <div class="loading"></div>
                </div>
            </div>

            <div class="failures-panel">
                <h2 class="chart-title">Recent Failures</h2>
                <div id="failuresList">
                    <div class="loading"></div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Performance Overview</h2>
            <div style="position: relative; height: 320px;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Chart instance
        let performanceChart;

        // Initialize dashboard
        async function initDashboard() {
            await loadStats();
            await loadDatasets();
            await loadFailures();
            initChart();
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await axios.get('/api/stats');
                const stats = response.data.overview;

                const totalDatasets = stats.total_datasets || 0;
                const successful = stats.successful || 0;
                const failed = stats.failed || 0;
                const successRate = totalDatasets > 0 ? Math.round((successful / totalDatasets) * 100) : 0;

                document.getElementById('totalDatasets').textContent = totalDatasets;
                document.getElementById('recordsSynced').textContent = formatNumber(stats.total_records || 0);
                document.getElementById('failedSyncs').textContent = failed;

                const successRateEl = document.getElementById('successRate');
                successRateEl.textContent = successRate + '%';

                // Color code success rate
                if (successRate >= 90) {
                    successRateEl.className = 'stat-value success-rate good';
                } else if (successRate >= 70) {
                    successRateEl.className = 'stat-value success-rate warning';
                } else {
                    successRateEl.className = 'stat-value success-rate poor';
                }

            } catch (error) {
                console.error('Failed to load stats:', error);
                showError('Failed to load statistics');
            }
        }

        // Load dataset list
        async function loadDatasets() {
            try {
                const response = await axios.get('/api/datasets');
                const datasets = response.data.datasets;

                const container = document.getElementById('datasetsList');
                container.innerHTML = '';

                if (datasets.length === 0) {
                    container.innerHTML = '<div class="empty-state">No datasets found</div>';
                    return;
                }

                datasets.forEach(dataset => {
                    const item = createDatasetItem(dataset);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Failed to load datasets:', error);
                showError('Failed to load datasets');
            }
        }

        // Load failures
        async function loadFailures() {
            try {
                const response = await axios.get('/api/failures');
                const failures = response.data;

                const container = document.getElementById('failuresList');
                container.innerHTML = '';

                if (failures.length === 0) {
                    container.innerHTML = '<div class="empty-state">‚úÖ No recent failures</div>';
                    return;
                }

                failures.forEach(failure => {
                    const item = createFailureItem(failure);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Failed to load failures:', error);
                showError('Failed to load failure data');
            }
        }

        // Create dataset item element
        function createDatasetItem(dataset) {
            const div = document.createElement('div');
            div.className = 'dataset-item';
            div.onclick = () => showDatasetInfo(dataset);

            const statusClass = dataset.last_status || 'pending';
            const lastSync = formatDate(dataset.last_run);

            div.innerHTML = `
                <div class="dataset-name">${dataset.dataset_name || dataset.dataset_id}</div>
                <div class="dataset-meta">
                    <span class="dataset-status ${statusClass}">${statusClass || 'unknown'}</span>
                    <span class="dataset-frequency">${dataset.sync_frequency}</span>
                    <button class="btn" onclick="event.stopPropagation(); triggerSync('${dataset.dataset_id}')">
                        Trigger
                    </button>
                </div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    Last sync: ${lastSync} | Records: ${dataset.records_processed || 0}
                </div>
            `;

            return div;
        }

        // Create failure item element
        function createFailureItem(failure) {
            const div = document.createElement('div');
            div.className = 'failure-item';

            div.innerHTML = `
                <div class="failure-name">${failure.dataset_name}</div>
                <div class="failure-message">${failure.error_message || 'Unknown error'}</div>
                <div style="font-size: 12px; color: #7f1d1d; margin-top: 8px;">
                    ${formatDate(failure.start_time)}
                </div>
            `;

            return div;
        }

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            // Generate sample data for demo
            const hours = [];
            const successData = [];
            const totalData = [];

            for (let i = 23; i >= 0; i--) {
                const date = new Date();
                date.setHours(date.getHours() - i);
                hours.push(date.getHours() + ':00');

                const total = Math.floor(Math.random() * 20) + 5;
                const success = Math.floor(total * (0.7 + Math.random() * 0.3));

                totalData.push(total);
                successData.push(success);
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Total Syncs',
                        data: totalData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Successful Syncs',
                        data: successData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Last 24 Hours Performance'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Syncs'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour'
                            }
                        }
                    }
                }
            });
        }

        // Show dataset info
        function showDatasetInfo(dataset) {
            alert(`Dataset: ${dataset.dataset_name}
Source: ${dataset.source_url}
Type: ${dataset.source_type}
Frequency: ${dataset.sync_frequency}
Status: ${dataset.last_status || 'Unknown'}
Last Sync: ${formatDate(dataset.last_run)}`);
        }

        // Trigger sync for specific dataset
        async function triggerSync(datasetId) {
            try {
                const response = await axios.post(`/api/trigger/${datasetId}`);
                if (response.data.success) {
                    alert('‚úÖ ' + response.data.message);
                    // Reload data after a short delay
                    setTimeout(() => {
                        loadDatasets();
                        loadStats();
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to trigger sync:', error);
                alert('‚ùå Failed to trigger sync');
            }
        }

        // Utility functions
        function formatNumber(num) {
            if (num > 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num > 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';

            try {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;

                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;

                return date.toLocaleDateString();
            } catch (e) {
                return 'Invalid date';
            }
        }

        function showError(message) {
            console.error(message);
            // You could show a toast notification here
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDashboard);

        // Refresh data every 30 seconds
        setInterval(() => {
            loadStats();
            loadDatasets();
            loadFailures();
        }, 30000);
    </script>
</body>
</html>